<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oray's Coaching</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        .slide-in { animation: slideUp 0.3s ease-out; }
        
        @keyframes pulse-cyan {
            0% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 211, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); }
        }
        .saving-pulse { animation: pulse-cyan 1s infinite; }
        
        @keyframes bounce-small {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .badge-bounce { animation: bounce-small 2s infinite; }

        @keyframes ping-slow {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-ping-slow { animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "oray.gungor@gmail.com";
        const APP_VERSION = "v0.13";

        const firebaseConfig = {
            apiKey: "AIzaSyCu-H_z8dwFV7tc4uS1o79SDD-Cm7Hvei4",
            authDomain: "orayscoaching.firebaseapp.com",
            projectId: "orayscoaching",
            storageBucket: "orayscoaching.firebasestorage.app",
            messagingSenderId: "1048235208546",
            appId: "1:1048235208546:web:6dc7c85f37e3acea12863b",
            measurementId: "G-D81JXVP6EZ"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- SOUNDS ---
        const NOTIFICATION_SOUND = "data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";

        // --- ICONS SYSTEM ---
        const { useState, useEffect, useRef } = React;

        const IconBase = ({ size = 24, children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Icons = {
            ChevronLeft: (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>,
            ChevronRight: (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>,
            XCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>,
            Activity: (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            TrendingUp: (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            Heart: (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            Calendar: (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            MapPin: (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Zap: (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
            Flag: (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>,
            Timer: (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>,
            Gauge: (props) => <IconBase {...props}><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></IconBase>,
            Dumbbell: (props) => <IconBase {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            MessageCircle: (props) => <IconBase {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></IconBase>,
            Send: (props) => <IconBase {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconBase>,
            LogOut: (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Users: (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            CheckCircle2: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>,
            Bell: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>
        };

        const WORKOUT_TYPES = {
            long: { label: "Long Run", bgColor: "bg-blue-900/40", bgRaw: "bg-blue-900", textColor: "text-blue-100", defaultBorder: "border-blue-700/50", icon: <Icons.MapPin size={11} className="text-blue-400" /> },
            interval: { label: "Interval", bgColor: "bg-fuchsia-900/40", bgRaw: "bg-fuchsia-900", textColor: "text-fuchsia-100", defaultBorder: "border-fuchsia-700/50", icon: <Icons.Timer size={11} className="text-fuchsia-400" /> },
            race: { label: "Race", bgColor: "bg-rose-900/40", bgRaw: "bg-rose-900", textColor: "text-rose-100", defaultBorder: "border-rose-700/50", icon: <Icons.Flag size={11} className="text-rose-400" /> },
            stretching: { label: "Esneme", bgColor: "bg-cyan-900/40", bgRaw: "bg-cyan-900", textColor: "text-cyan-100", defaultBorder: "border-cyan-700/50", icon: <Icons.Activity size={11} className="text-cyan-400" /> },
            drills: { label: "Koşu Ekonomisi", bgColor: "bg-amber-900/40", bgRaw: "bg-amber-900", textColor: "text-amber-100", defaultBorder: "border-amber-700/50", icon: <Icons.Zap size={11} className="text-amber-400" /> },
            threshold: { label: "Lactate Threshold", bgColor: "bg-orange-900/40", bgRaw: "bg-orange-900", textColor: "text-orange-100", defaultBorder: "border-orange-700/50", icon: <Icons.Gauge size={11} className="text-orange-400" /> },
            workout: { label: "Workout", bgColor: "bg-zinc-800", bgRaw: "bg-zinc-800", textColor: "text-zinc-200", defaultBorder: "border-zinc-600", icon: <Icons.Dumbbell size={11} className="text-zinc-400" /> }
        };

        const STATUS_STYLES = {
            completed: "!border-4 !border-green-500 shadow-[0_0_15px_-3px_rgba(34,197,94,0.6)]",
            partial: "!border-4 !border-yellow-500 shadow-[0_0_15px_-3px_rgba(234,179,8,0.3)]",
            missed: "!border-4 !border-red-500 shadow-[0_0_15px_-3px_rgba(220,38,38,0.3)]",
            pending: "border"
        };

        const STATUS_CONFIG = {
            completed: { label: 'Tamam', class: 'bg-green-500/20 text-green-400 border-green-500/50', activeClass: 'bg-green-600 text-white' },
            partial: { label: 'Kısmen', class: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50', activeClass: 'bg-yellow-600 text-white' },
            missed: { label: 'Eksik', class: 'bg-red-500/20 text-red-400 border-red-500/50', activeClass: 'bg-red-600 text-white' },
            pending: { label: 'Plan', class: 'bg-slate-700/30 text-slate-400 border-slate-600', activeClass: 'bg-slate-600 text-white' }
        };

        const ZONE_COLORS = { 1: "bg-slate-600 text-slate-200", 2: "bg-blue-600 text-white", 3: "bg-green-600 text-white", 4: "bg-orange-600 text-white", 5: "bg-red-600 text-white" };

        // --- COMPONENTS ---

        const ChatWidget = ({ user, chatRoomId, targetName, hasUnread, onOpenChat }) => {
            if (!chatRoomId) return null;

            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState("");
            const messagesEndRef = useRef(null);
            
            // Local state to play sound if new message arrives while app is open
            const [msgCount, setMsgCount] = useState(0);
            const firstLoad = useRef(true);

            const playSound = () => {
                const audio = new Audio(NOTIFICATION_SOUND);
                audio.play().catch(e => console.log("Audio play failed"));
            };

            // Listen to messages
            useEffect(() => {
                if (!chatRoomId) return;
                const unsubscribe = db.collection("chats").doc(chatRoomId).collection("messages").orderBy("createdAt", "asc").onSnapshot((snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(msgs);
                    
                    if (!firstLoad.current && msgs.length > msgCount) {
                        const last = msgs[msgs.length - 1];
                        if (last.uid !== user.uid) playSound();
                    }
                    setMsgCount(msgs.length);
                    firstLoad.current = false;

                    if (isOpen) setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
                });
                return () => unsubscribe();
            }, [chatRoomId, user.uid, isOpen]);

            // Handle Open/Close and Clearing Flags
            const toggleChat = () => {
                const newState = !isOpen;
                setIsOpen(newState);
                if (newState) {
                    onOpenChat(); // Clear unread flags in DB
                    setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
                }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !chatRoomId) return;
                try {
                    await db.collection("chats").doc(chatRoomId).collection("messages").add({
                        text: newMessage, uid: user.uid, displayName: user.displayName || "User", photoURL: user.photoURL, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Set Notification Flags based on sender
                    const isCoach = user.email === ADMIN_EMAIL;
                    if (isCoach) {
                        // Coach sending -> Flag for Athlete
                        await db.collection("users").doc(chatRoomId).set({ hasUnreadCoachMessages: true }, { merge: true });
                    } else {
                        // Athlete sending -> Flag for Coach
                        await db.collection("users").doc(user.uid).set({ hasUnreadMessages: true }, { merge: true });
                    }

                    setNewMessage("");
                } catch (error) { console.error("Mesaj hatası:", error); }
            };

            return (
                <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end">
                    {isOpen && (
                        <div className="fixed inset-0 z-[100] w-full h-full sm:absolute sm:inset-auto sm:bottom-20 sm:right-0 sm:w-80 sm:h-96 bg-slate-900 border-0 sm:border border-slate-700 sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden slide-in">
                            <div className="bg-slate-800 p-4 sm:p-3 border-b border-slate-700 flex justify-between items-center">
                                <h3 className="text-white font-bold text-sm flex items-center gap-2"><Icons.MessageCircle size={16} className="text-cyan-400"/> {targetName}</h3>
                                <button onClick={toggleChat} className="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 transition-colors"><Icons.XCircle size={24}/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar bg-slate-900">
                                {messages.map(msg => (
                                    <div key={msg.id} className={`flex gap-2 ${msg.uid === user.uid ? 'flex-row-reverse' : ''}`}>
                                        <img src={msg.photoURL || "https://via.placeholder.com/32"} className="w-8 h-8 sm:w-6 sm:h-6 rounded-full border border-slate-600" alt="" />
                                        <div className={`rounded-2xl px-4 py-3 sm:px-3 sm:py-2 text-sm sm:text-xs max-w-[80%] sm:max-w-[75%] ${msg.uid === user.uid ? 'bg-cyan-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}`}>
                                            <p className="font-bold text-[10px] opacity-70 mb-0.5">{msg.displayName}</p>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                            <form onSubmit={handleSend} className="p-3 sm:p-2 border-t border-slate-700 bg-slate-800/50 flex gap-2 pb-safe">
                                <input value={newMessage} onChange={(e) => setNewMessage(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 rounded-full px-4 py-3 sm:px-3 sm:py-2 text-base sm:text-xs text-white focus:outline-none focus:border-cyan-500" placeholder="Mesaj yaz..." />
                                <button type="submit" className="bg-cyan-600 hover:bg-cyan-500 text-white p-3 sm:p-2 rounded-full transition"><Icons.Send size={18} /></button>
                            </form>
                        </div>
                    )}
                    <button onClick={toggleChat} className={`relative p-4 rounded-full shadow-lg shadow-cyan-900/50 transition-all hover:scale-105 active:scale-95 ${hasUnread ? 'bg-green-600 hover:bg-green-500' : 'bg-cyan-600 hover:bg-cyan-500'} text-white`}>
                        <Icons.MessageCircle size={24} />
                        {hasUnread && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-950 badge-bounce">!</span>}
                    </button>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 text-center animate-in">
                <div className="w-20 h-20 bg-gradient-to-tr from-cyan-600 to-blue-500 rounded-3xl flex items-center justify-center text-white font-extrabold text-3xl shadow-2xl shadow-cyan-900/50 transform rotate-6 mb-8">OC</div>
                <h1 className="text-4xl font-black text-white mb-2 tracking-tight">Oray's Coaching</h1>
                <p className="text-slate-400 mb-8 max-w-xs mx-auto">Elit atletler için kişiselleştirilmiş antrenman programı.</p>
                <button onClick={onLogin} className="flex items-center gap-3 bg-white text-slate-900 px-8 py-4 rounded-xl font-bold hover:bg-slate-100 transition-all active:scale-95 shadow-xl">Google ile Giriş Yap</button>
            </div>
        );

        const WorkoutModal = ({ selectedDate, workout = {}, isCoach, onClose, onSave, onDelete, onAutoSave, hasWorkout, onMarkRead }) => {
            const [localUserNote, setLocalUserNote] = useState(workout.userNote || "");
            const [saveStatus, setSaveStatus] = useState("idle");
            const [deleteConfirm, setDeleteConfirm] = useState(false);

            useEffect(() => { setLocalUserNote(workout.userNote || ""); }, [workout.userNote]);
            
            useEffect(() => { if (onMarkRead) onMarkRead(); }, []);

            const onUserNoteBlur = () => {
                if (localUserNote !== (workout.userNote || "")) {
                    setSaveStatus("saving");
                    onAutoSave(localUserNote).then(() => {
                        setSaveStatus("saved");
                        setTimeout(() => setSaveStatus("idle"), 2000);
                    });
                }
            };

            const handleDeleteClick = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (deleteConfirm) onDelete(); else { setDeleteConfirm(true); setTimeout(() => setDeleteConfirm(false), 3000); }
            };

            const canEditDetails = isCoach; 
            const canEditStatus = isCoach; 

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-md animate-in">
                    <div className="bg-slate-900 w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[95vh] slide-in">
                        <div className="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                            <div className="flex items-center gap-3">
                                {hasWorkout && isCoach && (
                                    <button type="button" onClick={handleDeleteClick} className={`p-2 rounded-full transition-all border mr-1 group flex items-center gap-2 ${deleteConfirm ? "bg-red-600 text-white border-red-600 w-auto px-3" : "bg-red-500/10 hover:bg-red-500/20 text-red-500 border-red-500/20"}`} title="Sil">
                                        <Icons.Trash2 size={18} /> {deleteConfirm && <span className="text-xs font-bold whitespace-nowrap">Sil?</span>}
                                    </button>
                                )}
                                <div>
                                    <div className="flex items-center gap-2 text-cyan-400 mb-0.5"><Icons.Calendar size={16} /><span className="text-xs font-bold tracking-widest uppercase opacity-80">{selectedDate.split('-')[0]}</span></div>
                                    <h2 className="text-xl font-bold text-white tracking-tight">{selectedDate.split('-').reverse().join('.')}</h2>
                                </div>
                            </div>
                            <button type="button" onClick={onClose} className="text-slate-400 hover:text-white p-2 transition-colors"><Icons.XCircle size={28} /></button>
                        </div>

                        <div className="p-5 overflow-y-auto custom-scrollbar">
                            <form id="workoutForm" onSubmit={onSave} className="space-y-6">
                                <div className="flex gap-2">
                                    {Object.entries(STATUS_CONFIG).map(([key, config]) => (
                                        <label key={key} className="flex-1 cursor-pointer group relative">
                                            <input type="radio" name="status" value={key} defaultChecked={workout.status === key || (!workout.status && key === 'pending')} className="peer sr-only" disabled={!canEditStatus} />
                                            <div className={`text-center py-3 rounded-xl text-xs font-bold transition-all duration-200 border ${config.class} peer-checked:${config.activeClass} peer-checked:scale-[1.02] peer-checked:shadow-lg peer-checked:border-transparent opacity-70 peer-checked:opacity-100 hover:opacity-100 ${!canEditStatus ? 'opacity-50 cursor-not-allowed' : ''}`}>{config.label}</div>
                                        </label>
                                    ))}
                                </div>

                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">1. Antrenman</label>
                                            <select name="type" defaultValue={workout.type || ""} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white text-sm" disabled={!canEditDetails} required>
                                                <option value="" disabled>-- Seçiniz --</option>
                                                {Object.entries(WORKOUT_TYPES).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">2. Antrenman</label>
                                            <select name="type2" defaultValue={workout.type2 || "none"} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white text-sm" disabled={!canEditDetails}>
                                                <option value="none">-- Yok --</option>
                                                {Object.entries(WORKOUT_TYPES).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Başlık</label>
                                        <input name="title" defaultValue={workout.title} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white font-medium placeholder-slate-600" placeholder="Örn: Hafta sonu uzun koşusu" readOnly={!canEditDetails} />
                                    </div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">KM</label>
                                            <div className="relative">
                                                <input name="km" defaultValue={workout.km} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white text-sm" placeholder="0k" readOnly={!canEditDetails} />
                                                <Icons.MapPin size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Zone</label>
                                            <div className="relative">
                                                <select name="zone" defaultValue={workout.zone || ""} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white text-sm appearance-none" disabled={!canEditDetails}>
                                                    <option value="">--</option>
                                                    {[1, 2, 3, 4, 5].map(z => <option key={z} value={z}>{z}</option>)}
                                                </select>
                                                <Icons.Zap size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Elev.</label>
                                            <div className="relative">
                                                <input name="elevation" defaultValue={workout.elevation} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-white text-sm" placeholder="0m" readOnly={!canEditDetails} />
                                                <Icons.TrendingUp size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Açıklama</label>
                                        <textarea name="description" defaultValue={workout.description} rows={3} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none text-slate-300 text-sm placeholder-slate-600" placeholder="Detaylar..." readOnly={!canEditDetails} />
                                    </div>
                                </div>

                                <div className="space-y-4 pt-2 border-t border-slate-800">
                                    <div className="bg-cyan-950/20 p-3 rounded-xl border border-cyan-900/30">
                                        <label className="flex items-center gap-2 text-[10px] font-bold text-cyan-400 mb-2 uppercase"><Icons.Activity size={12} /> Coach Notu</label>
                                        <textarea name="coachNote" defaultValue={workout.coachNote} className="w-full bg-transparent border-0 p-0 text-cyan-100 text-sm focus:ring-0 placeholder-cyan-500/30" placeholder="Notunuzu buraya girin..." readOnly={!canEditDetails} />
                                    </div>
                                    <div className="bg-emerald-950/20 p-3 rounded-xl border border-emerald-900/30 relative">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="flex items-center gap-2 text-[10px] font-bold text-emerald-400 uppercase"><Icons.Heart size={12} /> Sporcu Notu</label>
                                            {!isCoach && saveStatus === 'saved' && <span className="text-[10px] text-emerald-400 flex items-center gap-1"><Icons.CheckCircle2 size={12} /> Kaydedildi</span>}
                                        </div>
                                        {!isCoach ? (
                                            <textarea value={localUserNote} onChange={(e) => setLocalUserNote(e.target.value)} onBlur={onUserNoteBlur} className="w-full bg-transparent border-0 p-0 text-emerald-100 text-sm focus:ring-0 placeholder-emerald-500/30" placeholder="Antrenman nasıl geçti? Notlarını buraya yaz..." />
                                        ) : (
                                            <textarea name="userNote" defaultValue={workout.userNote} className="w-full bg-transparent border-0 p-0 text-emerald-100 text-sm focus:ring-0 placeholder-emerald-500/30" placeholder="Sporcu notu..." />
                                        )}
                                    </div>
                                </div>
                                <div className="h-6 sm:h-0"></div>
                            </form>
                        </div>

                        {isCoach && (
                            <div className="p-4 border-t border-slate-800 bg-slate-900 flex gap-3 sticky bottom-0 z-10 pb-8 sm:pb-4">
                                <button type="button" onClick={onClose} className="flex-1 py-3.5 rounded-xl font-medium text-slate-400 hover:bg-slate-800 transition-colors">Vazgeç</button>
                                <button type="submit" form="workoutForm" className="flex-[2] py-3.5 rounded-xl font-bold bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-lg shadow-cyan-900/40 active:scale-95 transition-all">Kaydet</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1)); 
            const [workouts, setWorkouts] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [athleteList, setAthleteList] = useState([]);
            const [selectedAthleteId, setSelectedAthleteId] = useState(null);
            
            // Current User Info (Notifications for Athlete)
            const [currentUserData, setCurrentUserData] = useState({});

            const isCoach = user?.email === ADMIN_EMAIL;

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        await db.collection('users').doc(currentUser.uid).set({
                            uid: currentUser.uid,
                            email: currentUser.email,
                            displayName: currentUser.displayName,
                            photoURL: currentUser.photoURL,
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        if (currentUser.email !== ADMIN_EMAIL) {
                            setSelectedAthleteId(currentUser.uid);
                        }
                        
                        // Listen to current user data for flags
                        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                            if (doc.exists) setCurrentUserData(doc.data());
                        });
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (isCoach) {
                    const unsubscribe = db.collection('users').onSnapshot(snapshot => {
                        const users = snapshot.docs.map(doc => doc.data()).filter(u => u.email !== ADMIN_EMAIL);
                        setAthleteList(users);
                    });
                    return () => unsubscribe();
                }
            }, [isCoach]);

            useEffect(() => {
                if (!selectedAthleteId) return;
                const unsubscribe = db.collection("workouts").where("athleteUid", "==", selectedAthleteId).onSnapshot((snapshot) => {
                        const data = {};
                        snapshot.forEach(doc => {
                            const workoutData = doc.data();
                            const dateKey = doc.id.split('_').pop(); 
                            if(dateKey) data[dateKey] = { ...workoutData, id: doc.id };
                        });
                        setWorkouts(data);
                    });
                return () => unsubscribe();
            }, [selectedAthleteId]);

            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (error) { alert("Giriş başarısız: " + error.message); }
            };

            const handleLogout = () => { auth.signOut(); setSelectedAthleteId(null); setWorkouts({}); };

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); 
            const startingDayIndex = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const handleDateClick = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                setSelectedDate(dateStr);
                setIsModalOpen(true);
            };

            const handleMarkRead = async () => {
                if (!selectedDate || !selectedAthleteId) return;
                const docId = `${selectedAthleteId}_${selectedDate}`;
                const updateField = isCoach ? { hasUnreadUserNote: false } : { hasUnreadCoachNote: false };
                try {
                    if (workouts[selectedDate]) {
                        await db.collection("workouts").doc(docId).set(updateField, { merge: true });
                    }
                } catch (err) { console.error("Error marking read", err); }
            };

            const handleCoachSave = async (e) => {
                e.preventDefault();
                if (!user || !selectedAthleteId) return;
                const formData = new FormData(e.target);
                const zoneVal = formData.get('zone');
                
                const updatedWorkout = {
                    athleteUid: selectedAthleteId,
                    title: formData.get('title'),
                    type: formData.get('type'),
                    type2: formData.get('type2'), 
                    km: formData.get('km'),
                    elevation: formData.get('elevation'),
                    zone: zoneVal === "" ? null : zoneVal,
                    description: formData.get('description'),
                    status: formData.get('status'),
                    coachNote: formData.get('coachNote'),
                    userNote: formData.get('userNote'),
                    updatedBy: user.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    hasUnreadCoachNote: true 
                };
                const docId = `${selectedAthleteId}_${selectedDate}`;
                try { await db.collection("workouts").doc(docId).set(updatedWorkout, { merge: true }); setIsModalOpen(false); } catch (err) { alert("Kaydedilemedi!"); }
            };

            const handleAthleteNoteSave = async (noteText) => {
                const workoutExists = workouts[selectedDate];
                if (!workoutExists && !noteText.trim()) return;
                const docId = `${selectedAthleteId}_${selectedDate}`;
                try {
                    const payload = {
                        userNote: noteText,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        hasUnreadUserNote: true 
                    };
                    if (!workoutExists) {
                        payload.athleteUid = selectedAthleteId;
                        payload.type = 'workout'; payload.status = 'pending'; payload.km = ""; payload.title = "Serbest Antrenman";
                    }
                    await db.collection("workouts").doc(docId).set(payload, { merge: true });
                    
                    // Also flag user on Dashboard for Coach
                    await db.collection("users").doc(selectedAthleteId).set({ hasUnreadNotes: true }, { merge: true });
                } catch (err) { console.error("Otomatik kayıt hatası:", err); }
            };

            const handleDeleteWorkout = async () => {
                try {
                    const docId = `${selectedAthleteId}_${selectedDate}`;
                    await db.collection("workouts").doc(docId).delete();
                    setIsModalOpen(false);
                } catch (err) { alert("Silinemedi!"); }
            };
            
            // Clear unread notes flag when coach enters athlete
            const handleSelectAthlete = (uid) => {
                setSelectedAthleteId(uid);
                // Clear note flag
                db.collection("users").doc(uid).set({ hasUnreadNotes: false }, { merge: true });
            };
            
            // Clear unread message flag when opening chat
            const handleOpenChat = () => {
                const targetId = isCoach ? selectedAthleteId : user.uid;
                if (targetId) {
                    const field = isCoach ? { hasUnreadMessages: false } : { hasUnreadCoachMessages: false };
                    db.collection("users").doc(targetId).set(field, { merge: true });
                }
            };

            if (isLoading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">Yükleniyor...</div>;
            if (!user) return <LoginScreen onLogin={handleGoogleLogin} />;

            if (isCoach && !selectedAthleteId) {
                return (
                    <div className="min-h-screen bg-slate-950 text-slate-200 p-6 animate-in">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-gradient-to-tr from-cyan-600 to-blue-500 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">OC</div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-white">Coach Dashboard</h1>
                                        <p className="text-xs text-cyan-500 font-mono mt-1">{APP_VERSION}</p>
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="bg-slate-800 p-3 rounded-full text-slate-400 hover:text-white"><Icons.LogOut size={20} /></button>
                            </div>
                            <h2 className="text-slate-400 text-sm font-bold uppercase tracking-widest mb-4">Atlet Listesi</h2>
                            <div className="grid gap-4">
                                {athleteList.length === 0 ? (
                                    <div className="p-8 text-center border border-dashed border-slate-700 rounded-2xl text-slate-500">Henüz kayıtlı atlet yok.</div>
                                ) : (
                                    athleteList.map(athlete => (
                                        <div key={athlete.uid} onClick={() => handleSelectAthlete(athlete.uid)} className="bg-slate-900 border border-slate-800 hover:border-cyan-600 p-4 rounded-2xl flex items-center justify-between cursor-pointer transition-all hover:bg-slate-800 group relative">
                                            <div className="flex items-center gap-4">
                                                <img src={athlete.photoURL || "https://via.placeholder.com/40"} className="w-12 h-12 rounded-full border-2 border-slate-700 group-hover:border-cyan-500 transition-colors" alt=""/>
                                                <div>
                                                    <h3 className="font-bold text-white text-lg">{athlete.displayName}</h3>
                                                    <p className="text-xs text-slate-500">{athlete.email}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {/* Dashboard Indicators */}
                                                {athlete.hasUnreadNotes && <Icons.FileText className="text-orange-500 animate-pulse" size={20} />}
                                                {athlete.hasUnreadMessages && <Icons.MessageCircle className="text-green-500 animate-pulse" size={20} />}
                                                <Icons.ChevronRight className="text-slate-600 group-hover:text-cyan-500" />
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Determine if current view has unread messages for ChatWidget
            const targetUserForChat = isCoach 
                ? athleteList.find(a => a.uid === selectedAthleteId) 
                : currentUserData;
            
            // If coach, check selected athlete's flag. If athlete, check own flag.
            const hasUnreadChat = isCoach 
                ? targetUserForChat?.hasUnreadMessages 
                : targetUserForChat?.hasUnreadCoachMessages;

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-blue-500/30 pb-24 animate-in">
                    <div className="sticky top-0 z-30 bg-slate-950/80 backdrop-blur-md border-b border-slate-800">
                        <div className="max-w-md mx-auto px-4 pt-4 pb-2">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3">
                                    {isCoach ? (
                                        <button onClick={() => setSelectedAthleteId(null)} className="flex items-center gap-2 text-slate-400 hover:text-white transition">
                                            <Icons.ChevronLeft size={20} /> <span className="text-sm font-bold">Atletler</span>
                                        </button>
                                    ) : (
                                        <div className="w-10 h-10 bg-gradient-to-tr from-cyan-600 to-blue-500 rounded-xl flex items-center justify-center text-white font-extrabold shadow-lg shadow-cyan-900/50 transform rotate-3">OC</div>
                                    )}
                                    
                                    <div>
                                        <h1 className="text-lg font-bold text-white leading-none tracking-tight text-right">
                                            {isCoach 
                                                ? (athleteList.find(a => a.uid === selectedAthleteId)?.displayName || 'Atlet') 
                                                : "Oray's Coaching"}
                                        </h1>
                                        <p className="text-[10px] font-medium text-slate-500 uppercase tracking-widest mt-0.5 text-right">
                                            {isCoach ? 'Program Düzenleme' : user.displayName}
                                        </p>
                                    </div>
                                </div>
                                {!isCoach && (
                                    <button onClick={handleLogout} className="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white"><Icons.LogOut size={16} /></button>
                                )}
                            </div>
                            <div className="flex items-center justify-between bg-slate-900/50 p-1 rounded-2xl border border-slate-800">
                                <button onClick={prevMonth} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft size={20} /></button>
                                <h2 className="text-lg font-bold text-white tracking-wide">{monthNames[currentDate.getMonth()]} <span className="text-slate-500 font-normal">{currentDate.getFullYear()}</span></h2>
                                <button onClick={nextMonth} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight size={20} /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-md mx-auto px-3 mt-4">
                        <div className="grid grid-cols-7 mb-2">
                            {["Pzt", "Sal", "Çar", "Per", "Cum", "Cmt", "Paz"].map(day => (<div key={day} className="text-center text-[10px] font-bold text-slate-600 uppercase tracking-widest py-1">{day}</div>))}
                        </div>
                        <div className="grid grid-cols-7 gap-1.5 auto-rows-fr">
                            {Array.from({ length: startingDayIndex }).map((_, i) => (<div key={`empty-${i}`} className="min-h-[80px]"></div>))}
                            {Array.from({ length: daysInMonth }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const workout = workouts[dateStr];
                                const isToday = new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                                const type1 = workout && workout.type && WORKOUT_TYPES[workout.type] ? WORKOUT_TYPES[workout.type] : WORKOUT_TYPES['workout'];
                                const type2Key = workout && workout.type2 && WORKOUT_TYPES[workout.type2] ? workout.type2 : null;
                                const type2 = type2Key ? WORKOUT_TYPES[type2Key] : null;
                                const status = workout ? (workout.status || 'pending') : null;
                                
                                const showNotification = workout && (
                                    (isCoach && workout.hasUnreadUserNote) || 
                                    (!isCoach && workout.hasUnreadCoachNote)
                                );

                                let containerBgClass = 'bg-slate-900'; 
                                let containerBorderClass = 'border-slate-800 hover:border-slate-700'; 

                                if (workout) {
                                    if (type2) containerBgClass = 'bg-slate-900'; 
                                    else containerBgClass = type1.bgColor;

                                    if (status && status !== 'pending') containerBorderClass = STATUS_STYLES[status];
                                    else containerBorderClass = `border ${type1.defaultBorder}`;
                                }

                                return (
                                    <div key={day} onClick={() => handleDateClick(day)} className={`relative min-h-[90px] sm:min-h-[100px] rounded-xl transition-all duration-200 cursor-pointer active:scale-95 flex flex-col overflow-hidden group ${containerBgClass} ${containerBorderClass} ${isToday ? 'ring-2 ring-cyan-500 ring-offset-2 ring-offset-slate-950 z-10' : ''}`}>
                                        {showNotification && (
                                            <div className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full z-20 shadow-lg shadow-red-500/50 animate-ping-slow"></div>
                                        )}
                                        {showNotification && (
                                            <div className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full z-20 border border-slate-900"></div>
                                        )}

                                        {workout && type2 && (
                                            <>
                                                <div className={`absolute inset-0 w-full h-full z-0 ${type1.bgRaw} opacity-40 [clip-path:polygon(0_0,100%_0,0_100%)]`}></div>
                                                <div className={`absolute inset-0 w-full h-full z-0 ${type2.bgRaw} opacity-40 [clip-path:polygon(100%_0,100%_100%,0_100%)]`}></div>
                                            </>
                                        )}
                                        <div className="relative z-10 flex justify-between items-start mb-1 p-1.5 pb-0">
                                            <span className={`text-xs font-bold ${isToday ? 'text-cyan-400' : 'text-slate-300/80 drop-shadow-md'}`}>{day}</span>
                                            {workout && (<div className="flex gap-1 opacity-90 drop-shadow-md">{type1.icon}{type2 && type2.icon}</div>)}
                                        </div>
                                        {workout ? (
                                            <div className="relative z-10 flex flex-col flex-1 justify-center gap-1.5 p-1 pt-0">
                                                <div className="text-center"><span className={`text-lg font-black tracking-tight leading-none block drop-shadow-md ${type1.textColor}`}>{workout.km}</span></div>
                                                <div className="flex justify-center gap-1 flex-wrap">
                                                    {workout.zone && (<span className={`text-[9px] font-bold px-1 py-0.5 rounded-sm shadow-sm ${ZONE_COLORS[workout.zone]}`}>Z{workout.zone}</span>)}
                                                    {workout.elevation && (<span className="text-[9px] font-bold bg-black/40 text-white/90 px-1 py-0.5 rounded-sm backdrop-blur-sm">{workout.elevation}</span>)}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex-1 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <div className="w-5 h-5 rounded-full bg-slate-800 flex items-center justify-center text-slate-500 border border-slate-700"><span className="text-sm font-light leading-none mb-0.5">+</span></div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {isModalOpen && (
                        <WorkoutModal 
                            selectedDate={selectedDate} 
                            workout={workouts[selectedDate] || {}} 
                            isCoach={isCoach}
                            onClose={() => setIsModalOpen(false)}
                            onSave={handleCoachSave}
                            onDelete={handleDeleteWorkout}
                            onAutoSave={handleAthleteNoteSave}
                            hasWorkout={!!workouts[selectedDate]}
                            onMarkRead={handleMarkRead}
                        />
                    )}
                    <ChatWidget 
                        user={user} 
                        chatRoomId={selectedAthleteId} 
                        targetName={isCoach ? (athleteList.find(a => a.uid === selectedAthleteId)?.displayName || 'Atlet') : "Coach"}
                        hasUnread={hasUnreadChat}
                        onOpenChat={handleOpenChat}
                    />
                    <div className="fixed bottom-4 left-4 text-[10px] text-slate-600 font-mono">{APP_VERSION}</div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
