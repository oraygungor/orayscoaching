<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oray's Coaching</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        .slide-in { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "oray.gungor@gmail.com";

        const firebaseConfig = {
            apiKey: "AIzaSyCu-H_z8dwFV7tc4uS1o79SDD-Cm7Hvei4",
            authDomain: "orayscoaching.firebaseapp.com",
            projectId: "orayscoaching",
            storageBucket: "orayscoaching.firebasestorage.app",
            messagingSenderId: "1048235208546",
            appId: "1:1048235208546:web:6dc7c85f37e3acea12863b",
            measurementId: "G-D81JXVP6EZ"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ICONS ---
        const Icons = {
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Heart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Flag: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
            Timer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>,
            Gauge: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
            Dumbbell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            MessageCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        const WORKOUT_TYPES = {
            long: { label: "Long Run", bgColor: "bg-blue-900/40", bgRaw: "bg-blue-900", textColor: "text-blue-100", defaultBorder: "border-blue-700/50", icon: <Icons.MapPin size={12} className="text-blue-400" /> },
            interval: { label: "Interval", bgColor: "bg-fuchsia-900/40", bgRaw: "bg-fuchsia-900", textColor: "text-fuchsia-100", defaultBorder: "border-fuchsia-700/50", icon: <Icons.Timer size={12} className="text-fuchsia-400" /> },
            race: { label: "Race", bgColor: "bg-rose-900/40", bgRaw: "bg-rose-900", textColor: "text-rose-100", defaultBorder: "border-rose-700/50", icon: <Icons.Flag size={12} className="text-rose-400" /> },
            stretching: { label: "Esneme", bgColor: "bg-cyan-900/40", bgRaw: "bg-cyan-900", textColor: "text-cyan-100", defaultBorder: "border-cyan-700/50", icon: <Icons.Activity size={12} className="text-cyan-400" /> },
            drills: { label: "Koşu Ekonomisi", bgColor: "bg-amber-900/40", bgRaw: "bg-amber-900", textColor: "text-amber-100", defaultBorder: "border-amber-700/50", icon: <Icons.Zap size={12} className="text-amber-400" /> },
            threshold: { label: "Lactate Threshold", bgColor: "bg-orange-900/40", bgRaw: "bg-orange-900", textColor: "text-orange-100", defaultBorder: "border-orange-700/50", icon: <Icons.Gauge size={12} className="text-orange-400" /> },
            workout: { label: "Workout", bgColor: "bg-zinc-800", bgRaw: "bg-zinc-800", textColor: "text-zinc-200", defaultBorder: "border-zinc-600", icon: <Icons.Dumbbell size={12} className="text-zinc-400" /> }
        };

        const STATUS_STYLES = {
            completed: "!border-4 !border-green-500 shadow-[0_0_15px_-3px_rgba(34,197,94,0.6)]",
            partial: "!border-4 !border-yellow-500 shadow-[0_0_15px_-3px_rgba(234,179,8,0.3)]",
            missed: "!border-4 !border-red-500 shadow-[0_0_15px_-3px_rgba(220,38,38,0.3)]",
            pending: "border"
        };

        const STATUS_CONFIG = {
            completed: { label: 'Tamam', class: 'bg-green-500/20 text-green-400 border-green-500/50', activeClass: 'bg-green-600 text-white' },
            partial: { label: 'Kısmen', class: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50', activeClass: 'bg-yellow-600 text-white' },
            missed: { label: 'Eksik', class: 'bg-red-500/20 text-red-400 border-red-500/50', activeClass: 'bg-red-600 text-white' },
            pending: { label: 'Plan', class: 'bg-slate-700/30 text-slate-400 border-slate-600', activeClass: 'bg-slate-600 text-white' }
        };

        const ZONE_COLORS = { 1: "bg-slate-600 text-slate-200", 2: "bg-blue-600 text-white", 3: "bg-green-600 text-white", 4: "bg-orange-600 text-white", 5: "bg-red-600 text-white" };

        // --- COMPONENTS ---

        const ChatWidget = ({ user, chatRoomId, targetName }) => {
            if (!chatRoomId) return null; // Chat odası yoksa (örn: Coach dashboard'da) gösterme

            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState("");
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!isOpen || !chatRoomId) return;
                
                // Mesajlar artık global "messages" yerine "chats/{chatRoomId}/messages" altında
                const unsubscribe = db.collection("chats")
                    .doc(chatRoomId)
                    .collection("messages")
                    .orderBy("createdAt", "asc")
                    .onSnapshot((snapshot) => {
                        const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setMessages(msgs);
                        setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
                    });
                return () => unsubscribe();
            }, [isOpen, chatRoomId]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !chatRoomId) return;
                
                try {
                    await db.collection("chats")
                        .doc(chatRoomId)
                        .collection("messages")
                        .add({
                            text: newMessage,
                            uid: user.uid,
                            displayName: user.displayName || "User",
                            photoURL: user.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    setNewMessage("");
                } catch (error) {
                    console.error("Mesaj hatası:", error);
                }
            };

            return (
                <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end">
                    {isOpen && (
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-80 h-96 mb-4 flex flex-col overflow-hidden slide-in">
                            <div className="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center">
                                <h3 className="text-white font-bold text-sm flex items-center gap-2">
                                    <Icons.MessageCircle size={16} className="text-blue-400"/> {targetName}
                                </h3>
                                <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-white"><Icons.X size={16}/></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                                {messages.map(msg => (
                                    <div key={msg.id} className={`flex gap-2 ${msg.uid === user.uid ? 'flex-row-reverse' : ''}`}>
                                        <img src={msg.photoURL || "https://via.placeholder.com/32"} className="w-6 h-6 rounded-full border border-slate-600" alt="" />
                                        <div className={`rounded-2xl px-3 py-2 text-xs max-w-[75%] ${msg.uid === user.uid ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none'}`}>
                                            <p className="font-bold text-[10px] opacity-70 mb-0.5">{msg.displayName}</p>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>

                            <form onSubmit={handleSend} className="p-2 border-t border-slate-700 bg-slate-800/50 flex gap-2">
                                <input 
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-slate-600 rounded-full px-3 py-2 text-xs text-white focus:outline-none focus:border-blue-500"
                                    placeholder="Mesaj yaz..."
                                />
                                <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-full transition">
                                    <Icons.Send size={14} />
                                </button>
                            </form>
                        </div>
                    )}
                    
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-full shadow-lg shadow-blue-900/50 transition-all hover:scale-105 active:scale-95"
                    >
                        <Icons.MessageCircle size={24} />
                    </button>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 text-center animate-in">
                <div className="w-20 h-20 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-3xl flex items-center justify-center text-white font-extrabold text-3xl shadow-2xl shadow-blue-900/50 transform rotate-6 mb-8">OC</div>
                <h1 className="text-4xl font-black text-white mb-2 tracking-tight">Oray's Coaching</h1>
                <p className="text-slate-400 mb-8 max-w-xs mx-auto">Elit atletler için kişiselleştirilmiş antrenman programı.</p>
                <button onClick={onLogin} className="flex items-center gap-3 bg-white text-slate-900 px-8 py-4 rounded-xl font-bold hover:bg-slate-100 transition-all active:scale-95 shadow-xl">Google ile Giriş Yap</button>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1)); 
            const [workouts, setWorkouts] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            
            // Yeni State'ler (Coach Logic)
            const [athleteList, setAthleteList] = useState([]);
            const [selectedAthleteId, setSelectedAthleteId] = useState(null); // Coach'un görüntülediği atlet

            // Admin Kontrolü
            const isCoach = user?.email === ADMIN_EMAIL;

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        // Kullanıcı giriş yaptığında 'users' koleksiyonuna kaydet (ki coach listeyi görebilsin)
                        await db.collection('users').doc(currentUser.uid).set({
                            uid: currentUser.uid,
                            email: currentUser.email,
                            displayName: currentUser.displayName,
                            photoURL: currentUser.photoURL,
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        // Eğer kullanıcı atlet ise, otomatik olarak kendi ID'sini seç
                        if (currentUser.email !== ADMIN_EMAIL) {
                            setSelectedAthleteId(currentUser.uid);
                        }
                    }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Coach için Atlet Listesini Çek
            useEffect(() => {
                if (isCoach) {
                    const unsubscribe = db.collection('users').onSnapshot(snapshot => {
                        const users = snapshot.docs
                            .map(doc => doc.data())
                            .filter(u => u.email !== ADMIN_EMAIL); // Coach'u listeden çıkar
                        setAthleteList(users);
                    });
                    return () => unsubscribe();
                }
            }, [isCoach]);

            // Seçili Atlete Göre Veri Çekme (Dinamik Query)
            useEffect(() => {
                if (!selectedAthleteId) return;

                // Query: Seçilen atletin ID'sine sahip antrenmanları getir
                // Not: Burada daha basit olması için doc ID'yi "ATHLETEID_DATE" formatında tutacağız.
                // Böylece tüm koleksiyonu çekip filtrelemek yerine, sadece o kullanıcıya ait olanları
                // koleksiyon query'si ile alabiliriz veya (daha basiti) mevcut yapıyı koruyup
                // "workouts" koleksiyonunu dinleyip client-side filtreleriz (küçük ölçek için ok).
                // Ölçeklenebilirlik için "where" query kullanıyoruz.
                
                const unsubscribe = db.collection("workouts")
                    .where("athleteUid", "==", selectedAthleteId)
                    .onSnapshot((snapshot) => {
                        const data = {};
                        snapshot.forEach(doc => {
                            // Doc ID: "uid_date" formatında olacak, ama biz UI'da tarihi key olarak kullanıyoruz.
                            // Doc ID'den tarihi ayıralım veya data içine tarihi de kaydedelim.
                            const workoutData = doc.data();
                            const dateKey = doc.id.split('_').pop(); // "uid_2026-01-01" -> "2026-01-01"
                            if(dateKey) data[dateKey] = { ...workoutData, id: doc.id };
                        });
                        setWorkouts(data);
                    });
                return () => unsubscribe();
            }, [selectedAthleteId]);

            useEffect(() => { if (!isModalOpen) setDeleteConfirm(false); }, [isModalOpen]);

            const handleGoogleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (error) { alert("Giriş başarısız: " + error.message); }
            };

            const handleLogout = () => {
                auth.signOut();
                setSelectedAthleteId(null);
                setWorkouts({});
            };

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); 
            const startingDayIndex = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const handleDateClick = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                setSelectedDate(dateStr);
                setIsModalOpen(true);
            };

            const handleSaveWorkout = async (e) => {
                e.preventDefault();
                if (!user || !selectedAthleteId) return;

                const formData = new FormData(e.target);
                const zoneVal = formData.get('zone');

                const updatedWorkout = {
                    athleteUid: selectedAthleteId, // Kime ait olduğu
                    title: formData.get('title'),
                    type: formData.get('type'),
                    type2: formData.get('type2'), 
                    km: formData.get('km'),
                    elevation: formData.get('elevation'),
                    zone: zoneVal === "" ? null : zoneVal,
                    description: formData.get('description'),
                    status: formData.get('status'),
                    coachNote: formData.get('coachNote'),
                    userNote: formData.get('userNote'),
                    updatedBy: user.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // DOKÜMAN ID FORMATI: "USERID_TARİH"
                // Bu sayede her kullanıcının aynı gün için ayrı kaydı olur.
                const docId = `${selectedAthleteId}_${selectedDate}`;

                try {
                    await db.collection("workouts").doc(docId).set(updatedWorkout, { merge: true });
                    setIsModalOpen(false);
                } catch (err) {
                    console.error("Kaydetme hatası:", err);
                    alert("Kaydedilemedi!");
                }
            };

            const handleDeleteWorkout = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (deleteConfirm) {
                    try {
                        const docId = `${selectedAthleteId}_${selectedDate}`;
                        await db.collection("workouts").doc(docId).delete();
                        setIsModalOpen(false);
                    } catch (err) { console.error("Silme hatası:", err); alert("Silinemedi!"); }
                } else {
                    setDeleteConfirm(true);
                    setTimeout(() => setDeleteConfirm(false), 3000);
                }
            };

            const renderModal = () => {
                if (!selectedDate) return null;
                const workout = workouts[selectedDate] || {};
                const hasWorkout = !!workouts[selectedDate];
                
                // Permission Check: Coach her şeyi yapabilir, Athlete sadece User Note girebilir.
                // Status değişimi için: Coach değiştirebilir, Athlete değiştiremez (Prompt isteği)
                const canEditDetails = isCoach; 
                const canEditStatus = isCoach; 

                return (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/80 backdrop-blur-md animate-in">
                        <div className="bg-slate-900 w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[95vh] slide-in">
                            <div className="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                                <div className="flex items-center gap-3">
                                    {/* Silme Butonu: Sadece Coach ve var olan antrenman için */}
                                    {hasWorkout && isCoach && (
                                        <button type="button" onClick={handleDeleteWorkout} className={`p-2 rounded-full transition-all border mr-1 group flex items-center gap-2 ${deleteConfirm ? "bg-red-600 text-white border-red-600 w-auto px-3" : "bg-red-500/10 hover:bg-red-500/20 text-red-500 border-red-500/20"}`} title="Sil">
                                            <Icons.Trash2 size={18} /> {deleteConfirm && <span className="text-xs font-bold whitespace-nowrap">Sil?</span>}
                                        </button>
                                    )}
                                    <div>
                                        <div className="flex items-center gap-2 text-blue-400 mb-0.5"><Icons.Calendar size={16} /><span className="text-xs font-bold tracking-widest uppercase opacity-80">{selectedDate.split('-')[0]}</span></div>
                                        <h2 className="text-xl font-bold text-white tracking-tight">{selectedDate.split('-').reverse().join('.')}</h2>
                                    </div>
                                </div>
                                <button type="button" onClick={() => setIsModalOpen(false)} className="bg-slate-800 hover:bg-slate-700 text-slate-300 p-2 rounded-full transition-colors border border-slate-700"><Icons.X size={20} /></button>
                            </div>

                            <div className="p-5 overflow-y-auto custom-scrollbar">
                                <form id="workoutForm" key={selectedDate} onSubmit={handleSaveWorkout} className="space-y-6">
                                    <div className="flex gap-2">
                                        {Object.entries(STATUS_CONFIG).map(([key, config]) => (
                                            <label key={key} className="flex-1 cursor-pointer group relative">
                                                <input type="radio" name="status" value={key} defaultChecked={workout.status === key || (!workout.status && key === 'pending')} className="peer sr-only" disabled={!canEditStatus} />
                                                <div className={`text-center py-3 rounded-xl text-xs font-bold transition-all duration-200 border ${config.class} peer-checked:${config.activeClass} peer-checked:scale-[1.02] peer-checked:shadow-lg peer-checked:border-transparent opacity-70 peer-checked:opacity-100 hover:opacity-100 ${!canEditStatus ? 'opacity-50 cursor-not-allowed' : ''}`}>{config.label}</div>
                                            </label>
                                        ))}
                                    </div>

                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">1. Antrenman</label>
                                                <select name="type" defaultValue={workout.type || ""} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm" disabled={!canEditDetails} required>
                                                    <option value="" disabled>-- Seçiniz --</option>
                                                    {Object.entries(WORKOUT_TYPES).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">2. Antrenman</label>
                                                <select name="type2" defaultValue={workout.type2 || "none"} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm" disabled={!canEditDetails}>
                                                    <option value="none">-- Yok --</option>
                                                    {Object.entries(WORKOUT_TYPES).map(([key, val]) => (<option key={key} value={key}>{val.label}</option>))}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Başlık</label>
                                            <input name="title" defaultValue={workout.title} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white font-medium placeholder-slate-600" placeholder="Örn: Hafta sonu uzun koşusu" readOnly={!canEditDetails} />
                                        </div>
                                        <div className="grid grid-cols-3 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">KM</label>
                                                <div className="relative">
                                                    <input name="km" defaultValue={workout.km} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm" placeholder="0k" readOnly={!canEditDetails} />
                                                    <Icons.MapPin size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Zone</label>
                                                <div className="relative">
                                                    <select name="zone" defaultValue={workout.zone || ""} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm appearance-none" disabled={!canEditDetails}>
                                                        <option value="">--</option>
                                                        {[1, 2, 3, 4, 5].map(z => <option key={z} value={z}>{z}</option>)}
                                                    </select>
                                                    <Icons.Zap size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Elev.</label>
                                                <div className="relative">
                                                    <input name="elevation" defaultValue={workout.elevation} className="w-full p-3 pl-8 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-white text-sm" placeholder="0m" readOnly={!canEditDetails} />
                                                    <Icons.TrendingUp size={14} className="absolute left-2.5 top-3.5 text-slate-500" />
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Açıklama</label>
                                            <textarea name="description" defaultValue={workout.description} rows={3} className="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-slate-300 text-sm placeholder-slate-600" placeholder="Detaylar..." readOnly={!canEditDetails} />
                                        </div>
                                    </div>

                                    <div className="space-y-4 pt-2 border-t border-slate-800">
                                        <div className="bg-blue-950/20 p-3 rounded-xl border border-blue-900/30">
                                            <label className="flex items-center gap-2 text-[10px] font-bold text-blue-400 mb-2 uppercase"><Icons.Activity size={12} /> Coach Notu</label>
                                            <textarea name="coachNote" defaultValue={workout.coachNote} className="w-full bg-transparent border-0 p-0 text-blue-100 text-sm focus:ring-0 placeholder-blue-500/30" placeholder="Notunuzu buraya girin..." readOnly={!canEditDetails} />
                                        </div>
                                        <div className="bg-emerald-950/20 p-3 rounded-xl border border-emerald-900/30">
                                            <label className="flex items-center gap-2 text-[10px] font-bold text-emerald-400 mb-2 uppercase"><Icons.Heart size={12} /> Sporcu Notu</label>
                                            <textarea name="userNote" defaultValue={workout.userNote} className="w-full bg-transparent border-0 p-0 text-emerald-100 text-sm focus:ring-0 placeholder-emerald-500/30" placeholder="Sporcu geri bildirimi..." />
                                        </div>
                                    </div>
                                    <div className="h-6 sm:h-0"></div>
                                </form>
                            </div>

                            <div className="p-4 border-t border-slate-800 bg-slate-900 flex gap-3 sticky bottom-0 z-10 pb-8 sm:pb-4">
                                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3.5 rounded-xl font-medium text-slate-400 hover:bg-slate-800 transition-colors">Vazgeç</button>
                                <button type="submit" form="workoutForm" className="flex-[2] py-3.5 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-900/40 active:scale-95 transition-all">Kaydet</button>
                            </div>
                        </div>
                    </div>
                );
            };

            if (isLoading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">Yükleniyor...</div>;
            if (!user) return <LoginScreen onLogin={handleGoogleLogin} />;

            // --- COACH DASHBOARD (ATLET LİSTESİ) ---
            if (isCoach && !selectedAthleteId) {
                return (
                    <div className="min-h-screen bg-slate-950 text-slate-200 p-6 animate-in">
                        <div className="max-w-2xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">OC</div>
                                    <h1 className="text-2xl font-bold text-white">Coach Dashboard</h1>
                                </div>
                                <button onClick={handleLogout} className="bg-slate-800 p-3 rounded-full text-slate-400 hover:text-white"><Icons.LogOut size={20} /></button>
                            </div>
                            
                            <h2 className="text-slate-400 text-sm font-bold uppercase tracking-widest mb-4">Atlet Listesi</h2>
                            <div className="grid gap-4">
                                {athleteList.length === 0 ? (
                                    <div className="p-8 text-center border border-dashed border-slate-700 rounded-2xl text-slate-500">Henüz kayıtlı atlet yok.</div>
                                ) : (
                                    athleteList.map(athlete => (
                                        <div key={athlete.uid} onClick={() => setSelectedAthleteId(athlete.uid)} className="bg-slate-900 border border-slate-800 hover:border-blue-600 p-4 rounded-2xl flex items-center justify-between cursor-pointer transition-all hover:bg-slate-800 group">
                                            <div className="flex items-center gap-4">
                                                <img src={athlete.photoURL || "https://via.placeholder.com/40"} className="w-12 h-12 rounded-full border-2 border-slate-700 group-hover:border-blue-500 transition-colors" alt=""/>
                                                <div>
                                                    <h3 className="font-bold text-white text-lg">{athlete.displayName}</h3>
                                                    <p className="text-xs text-slate-500">{athlete.email}</p>
                                                </div>
                                            </div>
                                            <Icons.ChevronRight className="text-slate-600 group-hover:text-blue-500" />
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        {/* Coach için Dashboard'da sohbet yok, atlet seçince gelecek */}
                    </div>
                );
            }

            // --- CALENDAR VIEW (FOR BOTH) ---
            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-blue-500/30 pb-24 animate-in">
                    <div className="sticky top-0 z-30 bg-slate-950/80 backdrop-blur-md border-b border-slate-800">
                        <div className="max-w-md mx-auto px-4 pt-4 pb-2">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3">
                                    {/* Coach ise Geri Dön butonu, değilse Logo */}
                                    {isCoach ? (
                                        <button onClick={() => setSelectedAthleteId(null)} className="flex items-center gap-2 text-slate-400 hover:text-white transition">
                                            <Icons.ChevronLeft size={20} /> <span className="text-sm font-bold">Atletler</span>
                                        </button>
                                    ) : (
                                        <div className="w-10 h-10 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-xl flex items-center justify-center text-white font-extrabold shadow-lg shadow-blue-900/50 transform rotate-3">OC</div>
                                    )}
                                    
                                    <div>
                                        {/* Başlık: Coach ise izlediği atletin adı, değilse uygulama adı */}
                                        <h1 className="text-lg font-bold text-white leading-none tracking-tight text-right">
                                            {isCoach 
                                                ? (athleteList.find(a => a.uid === selectedAthleteId)?.displayName || 'Atlet') 
                                                : "Oray's Coaching"}
                                        </h1>
                                        <p className="text-[10px] font-medium text-slate-500 uppercase tracking-widest mt-0.5 text-right">
                                            {isCoach ? 'Program Düzenleme' : user.displayName}
                                        </p>
                                    </div>
                                </div>
                                {!isCoach && (
                                    <button onClick={handleLogout} className="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white"><Icons.LogOut size={16} /></button>
                                )}
                            </div>
                            <div className="flex items-center justify-between bg-slate-900/50 p-1 rounded-2xl border border-slate-800">
                                <button onClick={prevMonth} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft size={20} /></button>
                                <h2 className="text-lg font-bold text-white tracking-wide">{monthNames[currentDate.getMonth()]} <span className="text-slate-500 font-normal">{currentDate.getFullYear()}</span></h2>
                                <button onClick={nextMonth} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight size={20} /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-md mx-auto px-3 mt-4">
                        <div className="grid grid-cols-7 mb-2">
                            {["Pzt", "Sal", "Çar", "Per", "Cum", "Cmt", "Paz"].map(day => (<div key={day} className="text-center text-[10px] font-bold text-slate-600 uppercase tracking-widest py-1">{day}</div>))}
                        </div>
                        <div className="grid grid-cols-7 gap-1.5 auto-rows-fr">
                            {Array.from({ length: startingDayIndex }).map((_, i) => (<div key={`empty-${i}`} className="min-h-[80px]"></div>))}
                            {Array.from({ length: daysInMonth }).map((_, i) => {
                                const day = i + 1;
                                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const workout = workouts[dateStr];
                                const isToday = new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                                const type1 = workout && workout.type && WORKOUT_TYPES[workout.type] ? WORKOUT_TYPES[workout.type] : WORKOUT_TYPES['workout'];
                                const type2Key = workout && workout.type2 && WORKOUT_TYPES[workout.type2] ? workout.type2 : null;
                                const type2 = type2Key ? WORKOUT_TYPES[type2Key] : null;
                                const status = workout ? (workout.status || 'pending') : null;
                                
                                let containerBgClass = 'bg-slate-900'; 
                                let containerBorderClass = 'border-slate-800 hover:border-slate-700'; 

                                if (workout) {
                                    if (type2) containerBgClass = 'bg-slate-900'; 
                                    else containerBgClass = type1.bgColor;

                                    if (status && status !== 'pending') containerBorderClass = STATUS_STYLES[status];
                                    else containerBorderClass = `border ${type1.defaultBorder}`;
                                }

                                return (
                                    <div key={day} onClick={() => handleDateClick(day)} className={`relative min-h-[90px] sm:min-h-[100px] rounded-xl transition-all duration-200 cursor-pointer active:scale-95 flex flex-col overflow-hidden group ${containerBgClass} ${containerBorderClass} ${isToday ? 'ring-2 ring-blue-500 ring-offset-2 ring-offset-slate-950 z-10' : ''}`}>
                                        {workout && type2 && (
                                            <>
                                                <div className={`absolute inset-0 w-full h-full z-0 ${type1.bgRaw} opacity-40 [clip-path:polygon(0_0,100%_0,0_100%)]`}></div>
                                                <div className={`absolute inset-0 w-full h-full z-0 ${type2.bgRaw} opacity-40 [clip-path:polygon(100%_0,100%_100%,0_100%)]`}></div>
                                            </>
                                        )}
                                        <div className="relative z-10 flex justify-between items-start mb-1 p-1.5 pb-0">
                                            <span className={`text-xs font-bold ${isToday ? 'text-blue-400' : 'text-slate-300/80 drop-shadow-md'}`}>{day}</span>
                                            {workout && (<div className="flex gap-1 opacity-90 drop-shadow-md">{type1.icon}{type2 && type2.icon}</div>)}
                                        </div>
                                        {workout ? (
                                            <div className="relative z-10 flex flex-col flex-1 justify-center gap-1.5 p-1 pt-0">
                                                <div className="text-center"><span className={`text-lg font-black tracking-tight leading-none block drop-shadow-md ${type1.textColor}`}>{workout.km}</span></div>
                                                <div className="flex justify-center gap-1 flex-wrap">
                                                    {workout.zone && (<span className={`text-[9px] font-bold px-1 py-0.5 rounded-sm shadow-sm ${ZONE_COLORS[workout.zone]}`}>Z{workout.zone}</span>)}
                                                    {workout.elevation && (<span className="text-[9px] font-bold bg-black/40 text-white/90 px-1 py-0.5 rounded-sm backdrop-blur-sm">{workout.elevation}</span>)}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex-1 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <div className="w-5 h-5 rounded-full bg-slate-800 flex items-center justify-center text-slate-500 border border-slate-700"><span className="text-sm font-light leading-none mb-0.5">+</span></div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {isModalOpen && renderModal()}
                    <ChatWidget 
                        user={user} 
                        chatRoomId={selectedAthleteId} 
                        targetName={isCoach ? (athleteList.find(a => a.uid === selectedAthleteId)?.displayName || 'Atlet') : "Coach"}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
